name: Build Module

on:
  push:
    branches:
      - main
    paths:
      - src/**
      - tests/**
      - build.ps1
      - .github/workflows/build.yml

  workflow_dispatch:
    inputs:
      releaseNotes:
        description: Release notes for the build
        type: string
        required: false
        default: No release notes provided
      moduleVersion:
        description: The version of the module to build
        type: string
        required: false
        default: 0.0.0

env:
  PROJECT_URI: https://github.com/${{ github.repository}}
  MODULE_VERSION: 0.0.0
  RELEASE_NOTES: No release notes provided

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install External Modules
      shell: pwsh
      run: Install-Module -Name InvokeBuild, Az.KeyVault -Force

    - name: Set Environment Variables
      shell: pwsh
      run: |
        Import-Module ./src/GitHubTools.psm1

        Set-GhVariable -Name REPO_NAME -Value '${{ github.repository }}'.Split('/')[1]

        if ('${{ github.event.inputs.moduleVersion }}')
        {
          Set-GhVariable -Name MODULE_VERSION -Value '${{ github.event.inputs.moduleVersion }}'
        }

        if ('${{ github.event.inputs.releaseNotes }}')
        {
          Set-GhVariable -Name RELEASE_NOTES -Value '${{ github.event.inputs.releaseNotes }}'
        }

    - name: Build Module
      shell: pwsh
      run: Invoke-Build -File ./build.ps1 -Task Test, Build

    - name: Upload Code Coverage
      if: ${{ success() }}
      uses: actions/upload-artifact@v4
      with:
        name: code-coverage-report
        path: ${{ github.workspace }}/tests/coverage.xml

    - name: Upload Built Module
      if: ${{ success() }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.REPO_NAME }}-${{ env.MODULE_VERSION }}
        path: ${{ github.workspace }}/output
